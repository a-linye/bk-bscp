# 核心业务表外键依赖说明

本文档描述了租户迁移工具涉及的 29 张核心业务表的外键依赖关系。

---

## 一、表依赖层级总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Level 1 (基础表，无外键依赖)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  sharding_bizs    applications    template_spaces    groups                 │
│  hooks            credentials     template_variables                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Level 2 (依赖 Level 1)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  config_items (→applications)          releases (→applications)             │
│  strategy_sets (→applications)         template_sets (→template_spaces)     │
│  templates (→template_spaces)          hook_revisions (→hooks)              │
│  credential_scopes (→credentials)      group_app_binds (→groups,applications)│
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Level 3 (依赖 Level 1 和 Level 2)                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  commits                    contents                  strategies            │
│  current_published_strategies                         kvs                   │
│  released_config_items      released_groups           released_hooks        │
│  released_kvs               template_revisions        app_template_bindings │
│  app_template_variables     released_app_templates                          │
│  released_app_template_variables                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、各表详细外键说明

### Level 1：基础表（无外键依赖）

这些表只依赖 `biz_id` 进行数据过滤，不引用其他业务表的主键。

| 表名 | 说明 | 唯一索引 |
|------|------|----------|
| `sharding_bizs` | 业务分片信息 | `biz_id` |
| `applications` | 服务/应用 | `(biz_id, name)` |
| `template_spaces` | 模板空间 | `(biz_id, name)` |
| `groups` | 分组 | `(biz_id, name)` |
| `hooks` | 脚本钩子 | `(biz_id, name)` |
| `credentials` | 凭证/密钥 | `(biz_id, name)` |
| `template_variables` | 模板变量 | `(biz_id, name)` |

---

### Level 2：二级表（依赖 Level 1）

| 表名 | 外键字段 | 引用表 | 说明 |
|------|----------|--------|------|
| `config_items` | `app_id` | `applications` | 配置项 |
| `releases` | `app_id` | `applications` | 版本发布 |
| `strategy_sets` | `app_id` | `applications` | 策略集 |
| `template_sets` | `template_space_id` | `template_spaces` | 模板套餐 |
| `templates` | `template_space_id` | `template_spaces` | 模板文件 |
| `hook_revisions` | `hook_id` | `hooks` | 脚本版本 |
| `credential_scopes` | `credential_id` | `credentials` | 凭证关联规则 |
| `group_app_binds` | `group_id`, `app_id` | `groups`, `applications` | 分组与服务绑定 |

---

### Level 3：三级表（依赖 Level 1 和 Level 2）

| 表名 | 外键字段 | 引用表 | 说明 |
|------|----------|--------|------|
| `commits` | `app_id`, `config_item_id` | `applications`, `config_items` | 配置提交记录 |
| `contents` | `app_id`, `config_item_id` | `applications`, `config_items` | 配置内容 |
| `strategies` | `app_id`, `release_id`, `strategy_set_id` | `applications`, `releases`, `strategy_sets` | 发布策略 |
| `current_published_strategies` | `app_id`, `strategy_id`, `release_id`, `strategy_set_id` | `applications`, `strategies`, `releases`, `strategy_sets` | 当前发布策略 |
| `kvs` | `app_id` | `applications` | KV 配置项 |
| `released_config_items` | `app_id`, `release_id`, `commit_id`, `config_item_id` | `applications`, `releases`, `commits`, `config_items` | 已发布配置项 |
| `released_groups` | `app_id`, `group_id`, `release_id`, `strategy_id` | `applications`, `groups`, `releases`, `strategies` | 已发布分组 |
| `released_hooks` | `app_id`, `release_id`, `hook_id`, `hook_revision_id` | `applications`, `releases`, `hooks`, `hook_revisions` | 已发布脚本 |
| `released_kvs` | `app_id`, `release_id` | `applications`, `releases` | 已发布 KV |
| `template_revisions` | `template_space_id`, `template_id` | `template_spaces`, `templates` | 模板版本 |
| `app_template_bindings` | `app_id` | `applications` | 服务模板绑定 |
| `app_template_variables` | `app_id` | `applications` | 服务模板变量 |
| `released_app_templates` | `app_id`, `release_id` | `applications`, `releases` | 已发布服务模板 |
| `released_app_template_variables` | `app_id`, `release_id` | `applications`, `releases` | 已发布服务模板变量 |

---

## 三、迁移顺序

### 删除顺序（逆依赖）

清理目标库时，必须先删除依赖表，再删除被依赖表：

```
1. Level 3 (先删)
   released_app_template_variables → released_app_templates → app_template_variables →
   app_template_bindings → template_revisions → released_kvs → released_hooks →
   released_groups → released_config_items → kvs → current_published_strategies →
   strategies → contents → commits

2. Level 2
   group_app_binds → credential_scopes → hook_revisions → templates →
   template_sets → strategy_sets → releases → config_items

3. Level 1 (后删)
   template_variables → credentials → hooks → groups → template_spaces →
   applications → sharding_bizs
```

### 插入顺序（正依赖）

插入数据时，必须先插入被依赖表，再插入依赖表：

```
1. Level 1 (先插)
   sharding_bizs → applications → template_spaces → groups → hooks →
   credentials → template_variables

2. Level 2
   config_items → releases → strategy_sets → template_sets → templates →
   hook_revisions → credential_scopes → group_app_binds

3. Level 3 (后插)
   commits → contents → strategies → current_published_strategies → kvs →
   released_config_items → released_groups → released_hooks → released_kvs →
   template_revisions → app_template_bindings → app_template_variables →
   released_app_templates → released_app_template_variables
```

---

## 四、外键转换矩阵

迁移时，以下外键字段需要使用 ID 映射进行转换：

| 外键字段 | 涉及的表 |
|----------|----------|
| `app_id` | config_items, releases, strategy_sets, commits, contents, strategies, current_published_strategies, kvs, released_config_items, released_groups, released_hooks, released_kvs, app_template_bindings, app_template_variables, released_app_templates, released_app_template_variables, group_app_binds |
| `release_id` | strategies, current_published_strategies, released_config_items, released_groups, released_hooks, released_kvs, released_app_templates, released_app_template_variables |
| `config_item_id` | commits, contents, released_config_items |
| `commit_id` | released_config_items |
| `strategy_id` | current_published_strategies, released_groups |
| `strategy_set_id` | strategies, current_published_strategies |
| `template_space_id` | template_sets, templates, template_revisions |
| `template_id` | template_revisions |
| `hook_id` | hook_revisions, released_hooks |
| `hook_revision_id` | released_hooks |
| `group_id` | group_app_binds, released_groups |
| `credential_id` | credential_scopes |

---

## 五、Vault 路径依赖

Vault 中存储的 KV 数据路径依赖 MySQL 中的 ID：

| 数据类型 | Vault 路径格式 | 依赖的 ID |
|----------|---------------|-----------|
| 未发布 KV | `bk_bscp/biz/{biz_id}/apps/{app_id}/kvs/{key}` | `app_id` |
| 已发布 KV | `bk_bscp/biz/{biz_id}/apps/{app_id}/releases/{release_id}/kvs/{key}` | `app_id`, `release_id` |

因此，Vault 迁移必须在 MySQL 迁移之后进行，以获取正确的 ID 映射。

---
